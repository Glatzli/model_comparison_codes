Modeling a cold air pool in the Inn Valley: A
model intercomparison study
GOAL: till end of the year/mid Jan 1. draft of full thesis!
NEW GOAL: first draft as soon as realistically possible...

Creating VHD plots for 17 valley points
======================================================================

[1/17] Processing: ibk villa (ibk_villa)
Location: 47.260°N, 11.384°E
--------------------------------------------------
Loading/calculating VHD for AROME at ibk villa...
  Loading AROME from saved timeseries: arome_ibk_villa_timeseries_direct.nc
Point AROME HAF height = 2230.487060546875 m
Loading/calculating VHD for ICON at ibk villa...
  Loading ICON from saved timeseries: icon_ibk_villa_timeseries_direct.nc
Point ICON HAF height = 2146.096923828125 m
Loading/calculating VHD for ICON2TE at ibk villa...
  Loading ICON2TE from saved timeseries: icon2te_ibk_villa_timeseries_direct.nc
Point ICON2TE HAF height = 2146.096923828125 m
Loading/calculating VHD for UM at ibk villa...
  Loading UM from saved timeseries: um_ibk_villa_timeseries_direct.nc
Point UM HAF height = 2118.859375 m
Loading/calculating VHD for WRF at ibk villa...
  Loading WRF from saved timeseries: wrf_ibk_villa_timeseries_direct.nc
Point WRF HAF height = 2130.05712890625 m
Adding observational data (HATPRO)...
Point HATPRO HAF height = 2245 m
Point radio HAF height = 2276 m
  ✓ Comparison plot saved: vhd_model_comp_ibk villa_above_terrain.pdf

[2/17] Processing: ibk uni (ibk_uni)
Location: 47.264°N, 11.385°E
--------------------------------------------------
Loading/calculating VHD for AROME at ibk uni...
  Loading AROME from saved timeseries: arome_ibk_uni_timeseries_direct.nc
Point AROME HAF height = 2253.736572265625 m
Loading/calculating VHD for ICON at ibk uni...
  Loading ICON from saved timeseries: icon_ibk_uni_timeseries_direct.nc
Point ICON HAF height = 2146.096923828125 m
Loading/calculating VHD for ICON2TE at ibk uni...
  Loading ICON2TE from saved timeseries: icon2te_ibk_uni_timeseries_direct.nc
Point ICON2TE HAF height = 2146.096923828125 m
Loading/calculating VHD for UM at ibk uni...
  Loading UM from saved timeseries: um_ibk_uni_timeseries_direct.nc
Point UM HAF height = 2118.859375 m
Loading/calculating VHD for WRF at ibk uni...
  Loading WRF from saved timeseries: wrf_ibk_uni_timeseries_direct.nc
Point WRF HAF height = 2118.91162109375 m
Adding observational data (HATPRO)...
Point HATPRO HAF height = 2245 m
Point radio HAF height = 2276 m
  ✓ Comparison plot saved: vhd_model_comp_ibk uni_above_terrain.pdf

[3/17] Processing: ibk airport (ibk_airport)
Location: 47.260°N, 11.340°E
--------------------------------------------------
Loading/calculating VHD for AROME at ibk airport...
  Loading AROME from saved timeseries: arome_ibk_airport_timeseries_direct.nc
Point AROME HAF height = 2233.34228515625 m
Loading/calculating VHD for ICON at ibk airport...
  Loading ICON from saved timeseries: icon_ibk_airport_timeseries_direct.nc
Point ICON HAF height = 2142.67333984375 m
Loading/calculating VHD for ICON2TE at ibk airport...
  Loading ICON2TE from saved timeseries: icon2te_ibk_airport_timeseries_direct.nc
Point ICON2TE HAF height = 2142.67333984375 m
Loading/calculating VHD for UM at ibk airport...
  Loading UM from saved timeseries: um_ibk_airport_timeseries_direct.nc
Point UM HAF height = 2111.18798828125 m
Loading/calculating VHD for WRF at ibk airport...
  Loading WRF from saved timeseries: wrf_ibk_airport_timeseries_direct.nc
Point WRF HAF height = 2097.707763671875 m
Adding observational data (HATPRO)...
Point HATPRO HAF height = 2245 m
Point radio HAF height = 2276 m
  ✓ Comparison plot saved: vhd_model_comp_ibk airport_above_terrain.pdf

[4/17] Processing: Brenner Saddle (brenner_saddle)
Location: 47.006°N, 11.507°E
--------------------------------------------------
Loading/calculating VHD for AROME at Brenner Saddle...
  Loading AROME from saved timeseries: arome_brenner_saddle_timeseries_direct.nc
Point AROME HAF height = 3075.933837890625 m
Loading/calculating VHD for ICON at Brenner Saddle...
  Loading ICON from saved timeseries: icon_brenner_saddle_timeseries_direct.nc
Point ICON HAF height = 2816.85791015625 m
Loading/calculating VHD for ICON2TE at Brenner Saddle...
  Loading ICON2TE from saved timeseries: icon2te_brenner_saddle_timeseries_direct.nc
Point ICON2TE HAF height = 2816.85791015625 m
Loading/calculating VHD for UM at Brenner Saddle...
  Loading UM from saved timeseries: um_brenner_saddle_timeseries_direct.nc
Point UM HAF height = 3048.984619140625 m
Loading/calculating VHD for WRF at Brenner Saddle...
  Loading WRF from saved timeseries: wrf_brenner_saddle_timeseries_direct.nc
Point WRF HAF height = 2966.189453125 m
  ✓ Comparison plot saved: vhd_model_comp_Brenner Saddle_above_terrain.pdf

[5/17] Processing: between Stafflach and Steinach (wipp_stafflach_steinach)
Location: 47.072°N, 11.485°E
--------------------------------------------------
Loading/calculating VHD for AROME at between Stafflach and Steinach...
  Loading AROME from saved timeseries: arome_wipp_stafflach_steinach_timeseries_direct.nc
Point AROME HAF height = 2844.56005859375 m
Loading/calculating VHD for ICON at between Stafflach and Steinach...
  Loading ICON from saved timeseries: icon_wipp_stafflach_steinach_timeseries_direct.nc
Point ICON HAF height = 2738.96337890625 m
Loading/calculating VHD for ICON2TE at between Stafflach and Steinach...
  Loading ICON2TE from saved timeseries: icon2te_wipp_stafflach_steinach_timeseries_direct.nc
Point ICON2TE HAF height = 2738.96337890625 m
Loading/calculating VHD for UM at between Stafflach and Steinach...
  Loading UM from saved timeseries: um_wipp_stafflach_steinach_timeseries_direct.nc
Point UM HAF height = 2910.05517578125 m
Loading/calculating VHD for WRF at between Stafflach and Steinach...
  Loading WRF from saved timeseries: wrf_wipp_stafflach_steinach_timeseries_direct.nc
Point WRF HAF height = 2963.84814453125 m
  ✗ Error processing wipp_stafflach_steinach: [Errno 13] Permission denied: 'D:\\MSc_Arbeit\\plots\\vhd_plots\\vhd_model_comp_between_Stafflach_and_Steinach_direct.pdf'

[6/17] Processing: between Schoenberg and Matrei (wipp_schoenberg_matrei)
Location: 47.130°N, 11.450°E
--------------------------------------------------
Loading/calculating VHD for AROME at between Schoenberg and Matrei...
  Loading AROME from saved timeseries: arome_wipp_schoenberg_matrei_timeseries_direct.nc
Point AROME HAF height = 2676.918701171875 m
Loading/calculating VHD for ICON at between Schoenberg and Matrei...
  Loading ICON from saved timeseries: icon_wipp_schoenberg_matrei_timeseries_direct.nc
Point ICON HAF height = 2496.9189453125 m
Loading/calculating VHD for ICON2TE at between Schoenberg and Matrei...
  Loading ICON2TE from saved timeseries: icon2te_wipp_schoenberg_matrei_timeseries_direct.nc
Point ICON2TE HAF height = 2496.9189453125 m
Loading/calculating VHD for UM at between Schoenberg and Matrei...
  Loading UM from saved timeseries: um_wipp_schoenberg_matrei_timeseries_direct.nc
Point UM HAF height = 2542.155029296875 m
Loading/calculating VHD for WRF at between Schoenberg and Matrei...
  Loading WRF from saved timeseries: wrf_wipp_schoenberg_matrei_timeseries_direct.nc
Point WRF HAF height = 2563.40869140625 m
  ✓ Comparison plot saved: vhd_model_comp_between Schoenberg and Matrei_above_terrain.pdf

[7/17] Processing: Schoenberg in Stubai (wipp_schoenberg)
Location: 47.187°N, 11.405°E
--------------------------------------------------
Loading/calculating VHD for AROME at Schoenberg in Stubai...
  Loading AROME from saved timeseries: arome_wipp_schoenberg_timeseries_direct.nc
Point AROME HAF height = 2430.555419921875 m
Loading/calculating VHD for ICON at Schoenberg in Stubai...
  Loading ICON from saved timeseries: icon_wipp_schoenberg_timeseries_direct.nc
Point ICON HAF height = 2351.34716796875 m
Loading/calculating VHD for ICON2TE at Schoenberg in Stubai...
  Loading ICON2TE from saved timeseries: icon2te_wipp_schoenberg_timeseries_direct.nc
Point ICON2TE HAF height = 2351.34716796875 m
Loading/calculating VHD for UM at Schoenberg in Stubai...
  Loading UM from saved timeseries: um_wipp_schoenberg_timeseries_direct.nc
Point UM HAF height = 2376.5341796875 m
Loading/calculating VHD for WRF at Schoenberg in Stubai...
  Loading WRF from saved timeseries: wrf_wipp_schoenberg_timeseries_direct.nc
Point WRF HAF height = 2376.54443359375 m
  ✓ Comparison plot saved: vhd_model_comp_Schoenberg in Stubai_above_terrain.pdf

[8/17] Processing: Patsch Pfaffenbichl (patsch_EC_south)
Location: 47.209°N, 11.412°E
--------------------------------------------------
Loading/calculating VHD for AROME at Patsch Pfaffenbichl...
  Loading AROME from saved timeseries: arome_patsch_EC_south_timeseries_direct.nc
Point AROME HAF height = 2453.702880859375 m
Loading/calculating VHD for ICON at Patsch Pfaffenbichl...
  Loading ICON from saved timeseries: icon_patsch_EC_south_timeseries_direct.nc
Point ICON HAF height = 2298.448486328125 m
Loading/calculating VHD for ICON2TE at Patsch Pfaffenbichl...
  Loading ICON2TE from saved timeseries: icon2te_patsch_EC_south_timeseries_direct.nc
Point ICON2TE HAF height = 2298.448486328125 m
Loading/calculating VHD for UM at Patsch Pfaffenbichl...
  Loading UM from saved timeseries: um_patsch_EC_south_timeseries_direct.nc
Point UM HAF height = 2321.4130859375 m
Loading/calculating VHD for WRF at Patsch Pfaffenbichl...
  Loading WRF from saved timeseries: wrf_patsch_EC_south_timeseries_direct.nc
Point WRF HAF height = 2330.260009765625 m
  ✓ Comparison plot saved: vhd_model_comp_Patsch Pfaffenbichl_above_terrain.pdf

[9/17] Processing: Kochel (kochel)
Location: 47.670°N, 11.350°E
--------------------------------------------------
Loading/calculating VHD for AROME at Kochel...
  Loading AROME from saved timeseries: arome_kochel_timeseries_direct.nc
Point AROME HAF height = 2222.43115234375 m
Loading/calculating VHD for ICON at Kochel...
  Loading ICON from saved timeseries: icon_kochel_timeseries_direct.nc
Point ICON HAF height = 2099.816650390625 m
Loading/calculating VHD for ICON2TE at Kochel...
  Loading ICON2TE from saved timeseries: icon2te_kochel_timeseries_direct.nc
Point ICON2TE HAF height = 2099.816650390625 m
Loading/calculating VHD for UM at Kochel...
  Loading UM from saved timeseries: um_kochel_timeseries_direct.nc
Point UM HAF height = 2100.049560546875 m
Loading/calculating VHD for WRF at Kochel...
  Loading WRF from saved timeseries: wrf_kochel_timeseries_direct.nc
Point WRF HAF height = 2101.24609375 m
  ✓ Comparison plot saved: vhd_model_comp_Kochel_above_terrain.pdf

[10/17] Processing: Woergl (woergl)
Location: 47.494°N, 12.059°E
--------------------------------------------------
Loading/calculating VHD for AROME at Woergl...
  Loading AROME from saved timeseries: arome_woergl_timeseries_direct.nc
Point AROME HAF height = 2101.390869140625 m
Loading/calculating VHD for ICON at Woergl...
  Loading ICON from saved timeseries: icon_woergl_timeseries_direct.nc
Point ICON HAF height = 2061.69287109375 m
Loading/calculating VHD for ICON2TE at Woergl...
  Loading ICON2TE from saved timeseries: icon2te_woergl_timeseries_direct.nc
Point ICON2TE HAF height = 2061.69287109375 m
Loading/calculating VHD for UM at Woergl...
  Loading UM from saved timeseries: um_woergl_timeseries_direct.nc
Point UM HAF height = 2052.778564453125 m
Loading/calculating VHD for WRF at Woergl...
  Loading WRF from saved timeseries: wrf_woergl_timeseries_direct.nc
Point WRF HAF height = 2046.111083984375 m
  ✓ Comparison plot saved: vhd_model_comp_Woergl_above_terrain.pdf

[11/17] Processing: Jenbach (jenbach)
Location: 47.389°N, 11.758°E
--------------------------------------------------
Loading/calculating VHD for AROME at Jenbach...
  Loading AROME from saved timeseries: arome_jenbach_timeseries_direct.nc
Point AROME HAF height = 2444.933349609375 m
Loading/calculating VHD for ICON at Jenbach...
  Loading ICON from saved timeseries: icon_jenbach_timeseries_direct.nc
Point ICON HAF height = 2193.673583984375 m
Loading/calculating VHD for ICON2TE at Jenbach...
  Loading ICON2TE from saved timeseries: icon2te_jenbach_timeseries_direct.nc
Point ICON2TE HAF height = 2193.673583984375 m
Loading/calculating VHD for UM at Jenbach...
  Loading UM from saved timeseries: um_jenbach_timeseries_direct.nc
Point UM HAF height = 2197.921630859375 m
Loading/calculating VHD for WRF at Jenbach...
  Loading WRF from saved timeseries: wrf_jenbach_timeseries_direct.nc
Point WRF HAF height = 2203.79541015625 m
  ✗ Error processing jenbach: [Errno 13] Permission denied: 'D:\\MSc_Arbeit\\plots\\vhd_plots\\vhd_model_comp_Jenbach_direct.pdf'

[12/17] Processing: Kufstein (kufstein)
Location: 47.575°N, 12.163°E
--------------------------------------------------
Loading/calculating VHD for AROME at Kufstein...
  Loading AROME from saved timeseries: arome_kufstein_timeseries_direct.nc
Point AROME HAF height = 2160.126708984375 m
Loading/calculating VHD for ICON at Kufstein...
  Loading ICON from saved timeseries: icon_kufstein_timeseries_direct.nc
Point ICON HAF height = 2051.54345703125 m
Loading/calculating VHD for ICON2TE at Kufstein...
  Loading ICON2TE from saved timeseries: icon2te_kufstein_timeseries_direct.nc
Point ICON2TE HAF height = 2051.54345703125 m
Loading/calculating VHD for UM at Kufstein...
  Loading UM from saved timeseries: um_kufstein_timeseries_direct.nc
Point UM HAF height = 2123.3447265625 m
Loading/calculating VHD for WRF at Kufstein...
  Loading WRF from saved timeseries: wrf_kufstein_timeseries_direct.nc
Point WRF HAF height = 2135.41259765625 m
  ✓ Comparison plot saved: vhd_model_comp_Kufstein_above_terrain.pdf

[13/17] Processing: kiefersfelden (kiefersfelden)
Location: 47.620°N, 12.200°E
--------------------------------------------------
Loading/calculating VHD for AROME at kiefersfelden...
  Loading AROME from saved timeseries: arome_kiefersfelden_timeseries_direct.nc
Point AROME HAF height = 2077.733642578125 m
Loading/calculating VHD for ICON at kiefersfelden...
  Loading ICON from saved timeseries: icon_kiefersfelden_timeseries_direct.nc
Point ICON HAF height = 2207.7578125 m
Loading/calculating VHD for ICON2TE at kiefersfelden...
  Loading ICON2TE from saved timeseries: icon2te_kiefersfelden_timeseries_direct.nc
Point ICON2TE HAF height = 2207.7578125 m
Loading/calculating VHD for UM at kiefersfelden...
  Loading UM from saved timeseries: um_kiefersfelden_timeseries_direct.nc
Point UM HAF height = 2064.38916015625 m
Loading/calculating VHD for WRF at kiefersfelden...
  Loading WRF from saved timeseries: wrf_kiefersfelden_timeseries_direct.nc
Point WRF HAF height = 2023.2216796875 m
  ✗ Error processing kiefersfelden: [Errno 13] Permission denied: 'D:\\MSc_Arbeit\\plots\\vhd_plots\\vhd_model_comp_kiefersfelden_direct.pdf'

[14/17] Processing: Rosenheim (rosenheim)
Location: 47.867°N, 12.133°E
--------------------------------------------------
Loading/calculating VHD for AROME at Rosenheim...
  Loading AROME from saved timeseries: arome_rosenheim_timeseries_direct.nc
Point AROME HAF height = 2055.605712890625 m
Loading/calculating VHD for ICON at Rosenheim...
  Loading ICON from saved timeseries: icon_rosenheim_timeseries_direct.nc
Point ICON HAF height = 1972.21826171875 m
Loading/calculating VHD for ICON2TE at Rosenheim...
  Loading ICON2TE from saved timeseries: icon2te_rosenheim_timeseries_direct.nc
Point ICON2TE HAF height = 1972.21826171875 m
Loading/calculating VHD for UM at Rosenheim...
  Loading UM from saved timeseries: um_rosenheim_timeseries_direct.nc
Point UM HAF height = 1972.9503173828125 m
Loading/calculating VHD for WRF at Rosenheim...
  Loading WRF from saved timeseries: wrf_rosenheim_timeseries_direct.nc
Point WRF HAF height = 1965.8740234375 m
  ✓ Comparison plot saved: vhd_model_comp_Rosenheim_above_terrain.pdf

[15/17] Processing: Telfs (telfs)
Location: 47.300°N, 11.100°E
--------------------------------------------------
Loading/calculating VHD for AROME at Telfs...
  Loading AROME from saved timeseries: arome_telfs_timeseries_direct.nc
Point AROME HAF height = 2264.74951171875 m
Loading/calculating VHD for ICON at Telfs...
  Loading ICON from saved timeseries: icon_telfs_timeseries_direct.nc
Point ICON HAF height = 2227.82763671875 m
Loading/calculating VHD for ICON2TE at Telfs...
  Loading ICON2TE from saved timeseries: icon2te_telfs_timeseries_direct.nc
Point ICON2TE HAF height = 2227.82763671875 m
Loading/calculating VHD for UM at Telfs...
  Loading UM from saved timeseries: um_telfs_timeseries_direct.nc
Point UM HAF height = 2230.506103515625 m
Loading/calculating VHD for WRF at Telfs...
  Loading WRF from saved timeseries: wrf_telfs_timeseries_direct.nc
Point WRF HAF height = 2226.842041015625 m
  ✓ Comparison plot saved: vhd_model_comp_Telfs_above_terrain.pdf

[16/17] Processing: ziller valley (ziller_valley)
Location: 47.250°N, 11.900°E
--------------------------------------------------
Loading/calculating VHD for AROME at ziller valley...
  Loading AROME from saved timeseries: arome_ziller_valley_timeseries_direct.nc
Point AROME HAF height = 2263.32177734375 m
Loading/calculating VHD for ICON at ziller valley...
  Loading ICON from saved timeseries: icon_ziller_valley_timeseries_direct.nc
Point ICON HAF height = 2341.02734375 m
Loading/calculating VHD for ICON2TE at ziller valley...
  Loading ICON2TE from saved timeseries: icon2te_ziller_valley_timeseries_direct.nc
Point ICON2TE HAF height = 2341.02734375 m
Loading/calculating VHD for UM at ziller valley...
  Loading UM from saved timeseries: um_ziller_valley_timeseries_direct.nc
Point UM HAF height = 2366.484130859375 m
Loading/calculating VHD for WRF at ziller valley...
  Loading WRF from saved timeseries: wrf_ziller_valley_timeseries_direct.nc
Point WRF HAF height = 2393.89990234375 m
  ✓ Comparison plot saved: vhd_model_comp_ziller valley_above_terrain.pdf

[17/17] Processing: ziller ried (ziller_ried)
Location: 47.300°N, 11.870°E
--------------------------------------------------
Loading/calculating VHD for AROME at ziller ried...
  Loading AROME from saved timeseries: arome_ziller_ried_timeseries_direct.nc
Point AROME HAF height = 2418.31884765625 m
Loading/calculating VHD for ICON at ziller ried...
  Loading ICON from saved timeseries: icon_ziller_ried_timeseries_direct.nc
Point ICON HAF height = 2379.6650390625 m
Loading/calculating VHD for ICON2TE at ziller ried...
  Loading ICON2TE from saved timeseries: icon2te_ziller_ried_timeseries_direct.nc
Point ICON2TE HAF height = 2379.6650390625 m
Loading/calculating VHD for UM at ziller ried...
  Loading UM from saved timeseries: um_ziller_ried_timeseries_direct.nc
Point UM HAF height = 2410.446044921875 m
Loading/calculating VHD for WRF at ziller ried...
  Loading WRF from saved timeseries: wrf_ziller_ried_timeseries_direct.nc
Point WRF HAF height = 2426.4833984375 m
  ✓ Comparison plot saved: vhd_model_comp_ziller ried_above_terrain.pdf

======================================================================

ToDo: 
- Do I have to look at basin north of alps with high VHD in ICON?
- ziller ried ICON at 07:30-08:00, what's that?
- Woergl: wspd max. sinks down toward CAP?
- Theory review:
  	1st order closure, MOST, ...
  	turb. param. in models!
- pressure along valley plot
  	used airport pressure

  	reduction to Innsbruck Uni station:
	(Needs to assume constant temperature for barometric approach...)
	Height Ibk Uni: chose now 612m, is that right? original w. 578m pressure is much lower than others...
		-> where is the pressure sensor for this station?!
  	plot only difference ibk airport-kufstein

- th/wind height-time plot: has horizontal wind in it!
  	Add dewpoint depression variant?
  	would need calculation also for all plots and for HATPRO from spec humidity...

- VHD calculation: use "direct" height coordinate! due to hardcoded indexing for HAF-height IBK...

- cap height calculation:
  	took differentiate along "height" for dT: checked for icon ibk uni PCGP
  	then mask where "dT" is < 0, take rolling window along height with min. 3 values => took mean to find consecutive negatives
  	then mask for 3 (our desired consecutive neg. values)
  	and (maybe) shift it to get the lowest index and not the highest (not completely uniform in the models)
  	=> mask first True for lowest level of min. 3 consecutive dT values along height, then search height -> cap_height

- timeseries of depth of CAP:
  	when temperature decreases over 3 consecutive model levels => take lowest height for cap height
  	- calculation of full domain "worked" in calc_vhd, but that's messy => change everything to calc_cap_height and plot_cap_height fct!
  
  	(need to define a threshold -> paper: defined a threshhold for a stable layer
  		=> works only for a CBL!
  	plot then height below threshold over full domain -> just use level below threshold consistent for all models
  		=> be careful in the interpretation (f.e. 10 m difference - but model level distance is for 1 model 10m
  		and for the other 20m => probably no difference!)
  		(probably ppl look most on temp inversion because it's what we measure the longest...)
  	no clue how I should define smth for the vertical profiles, cause AROME, UM & WRF are pretty
  	smoothly increasing in pot temp. with height, there's no significant change in height...
  - probably I should plot vert. profile with wspds & specific humidity and not only pot. temp!
    	=> But how best?
    
    or evtl gradient Richardson Number?
    and Metpy radiosonde plot...)

- => würde zunehmende CAP depth beim Taleingang erwarten => aufgrund stärkerer Inversionen um 04UTC

2nd research goal:
	- Sens & Latent HF DOWN (negative) during day! -> turn signs that way around: 
		sens. heat flux transports heat down, which cools layers where the heat is transported away!
	- add printing of slope angle for points (large diff. for radiation!)
	- Are EC measurements parallel to horizontal plane or slope?!
	- Evtl Add Kolsass IBOX heat budget?
	
	- LWin:
   		should be higher when a lot of hum.: mostly ICON is most humid (skew-T plot), vert...
   		WRF has higher humidity -> higher LWin
   - lwu AROME wrong, swd WRF Helen fragen: falsche var gespeichert? wird für horiz. fläche berechnet und dann auf
     topograhie gerechnet
   - swu WRF upward shortwave flux: is that calculated from the horizontal variable or the one that is perpendicular to the
    terrain? 
=> Probably there's an error in reading in AROME/plotting the vars. Check again & create working daniel conda env!

WRF: lwu & swu are constant in time? -> prbbly error 

   - AROME shortwave: ~200W incoming sw and 200 outgoing on east-slope? Espc. where SWin is large, SWout is low and vice versa?
    	plot point on slope east & west in ziller valley?

 

	08:00 is interesting in AROME: look at vert. profiles on slopes f.e.: Do you see change in stability?
  		point north of patscherkofel (still cooling):
  
  add wind:
  strong winds work against strong cold pool production, in wipp valley there are higher wspds!
  maybe wind speed is higher up in AROME (maybe there also foehn in wipp valley)
  
	Temperatur-Unterschied zw niedrigstem modell-level und Boden & Austauchsckoeffizien

	compare inversions in Wipp & Ziller Valley: is layer much more stable in Wipp valley for WRF data (cause cooling is much more intense...):
		ziller ried point has at 04UTC 1degree stronger inversion for AROME; in Wipp valley thicker layer with nearly isothermal boundary layer,
  			ziller immediately cooling
  	difficulty: choose which timestep for which model to look at inversion for which point...?
  		-> time-evolution of depth of CAP is important!

  	should I use PCGP-method for comparing? - maybe not that point that I chose, but consistent...
  
- tests: have 1 for arome read in - but doesn't work...
  	-> don't waste too much time debugging code I don't understand!
  
make same plot for radiation!
- write routine for plotting energy balance: how does which part contribute to the onset/breakup of the CAP?

general points:
- inversion/sensible heat flux feedback: when inversion is strong it's damping wind speed, which is enhancing stability
  	(that HF is param. by wspd...)
- added geopot height as possible z coordinate in read in's

- How did Manuela interpolate the UM data? Manuela already compared qualitatively, can also look at the code...
- writing: Methodology immediately, important to not forget how I've done what!
	create file with plots and notes! Note what I did and already found!

- PCGP calc:
	-> calc slope angle with numpy and aspect with xDEM due to strange errors (ValueError: Surface fit and
  	rugosity require the same X and Y resolution ((0.013980000000000005, 0.009879999999999977) was given).
 	This was required by: ['slope'].)
	created .tif file from topography data with rioxarray, added WGS84 projection attribute. wrong!
		PROBLEM: would need vCRS: vertical coordinate reference system.

  	richDEM: looks finally good & consistent for DEM & models!
	
  	- WRF: took geometric height as topo (multiple levels at one one point, terrain height is only 2D) ~ 20m difference for ibk gridpoint or woergl gridpoint... 

- calc VHD:
  - plot HATPRO data only for ibk point?(timeseries plot)
  - add radiosonde (point plot)!
  - plot 80% of maximum VHD contour line for every model
 
  - UM has lower VHD at 04 in the morning -> assimilation? not everyone used same model for boundary conditions...
  	=> maybe due to that...
  
  can it be correct with only 0.3 MJ/m^2 (in model!) -> calc for radiosounding & HATPRO (cosma already did that a bit, but I have
  different calc with reference at Hafelekar and not at max temp.)
  
  general notes for calc:
	- take care that all needed vars are read if some are calculated! No checks included due to time-reasons...
	- are units for VHD calc right? I have 3*10^6 values, cosma 1.1*10^6 -> YES, everything ok! VHD larger as for cosma
 - plot VHD as hourly small multiples :)
 - result of full domain calc & then selecting PCGP is different from point calc?
   		-> different levels of hafelekar-level!   
   	check for ibk villa point (index HAF height there):
   	AROME: height = 37 at Hafelekar 
   	ICON: height = 32 at Hafelekar 
    UM: height = 22 at Hafelekar 
   	WRF: height = 31
   	HATPRO: height = 43
   		=> take the geopot height of IBK gridpoint! Finally the same!

 - zmax: how to find stable layers/inversion: plot pot temp profiles for mult stations, maybe take same threshold as
   lukas umek in his paper? in vert. profiles it looked pretty shallow. Man braucht irgendein Maß für stärke und dicke des
   CAPs. zB Inversionshöhe & VHD. Maybe search for profiles at my plots? Warum zB ist mein VHD größer am Taleingang-> profil!



general notes/inputs:
- heat budget calc:
	- find extent: look at 2m temperature => get overview of valley res.
- model topogrpahy: files: AROME_geopot_height_3dlowest_level.nc saved with "lat" & "lon"
- Preliminary work:
  	- Hannes only looked at SEB in AROME and WRF right? for UM no output -> manuela will ask peter for missing data
  	- 2nd research question: in Rauchoecker et al 2023 they looked at budget only for WRF model with this -> i don't have all these vars!
 
- introduce first models, then show results and not else!
- Understand all variables written in a figure (f.e. Hz = vertical comp of heat flux...)
- temp timeseries 2d plot: uncertainty from standard atm. is equal to interp. of AROME (manuela)
	=> maybe compute comparison...
	not that important for 2-d plot like that, more important for calc of advection f.e.: real values!
	created new dataset with geopot heigt as variable in z, take 20th timestep (16.10. at 06:30 UTC) for geopot. height
- humidity:
  	- rather use specific humidity for comparing between models cause rel. humidity is largely temp dependent! 
- (rotach: compare radiation to know what's causing temp difference (not in model vars available!), compute from pot temp: makes no sense, zirkelschluss...)
- find extent of CAP: look at 2m temperature => get overview of valley in models

- first plot: temp timeseries 2d: (differences are calculated from 0.5 hourly timesteps and *2 to get K/hr)
HATPRO: interpolated HATPRO data to AROME levels & used AROME pressure to calculate HATPRO pot temp
now pot temp timeseries for ibk for all models incl HATPRO
- regridded ICON equal to normal grid (pot temp plot ibk): looks good!



- netcdf file chunking: how to find saved chunks? used chunks="auto", works o.k.
- model topography: probably in 2D variables (?) hannes used geopotential height! how best? (model topo or real DEM?): Rachoecker hat auch schiachen overview-plot: mache Ausschnitt v AROME topo etw größer, hau Stadtnamen rein u slope profiles? Inn-Valley Beschriftung & passt scho?
search grid cells & plot temp along the cells to get along-valley cross section -> Hannes made topo plot from geopot height, hgt variable is only tuned to 2m!
HOBO dataset: https://zenodo.org/records/4672313

ICON: tried psy-view, but it's only possible to visualize one single level!
tried plotting with cartopy but somehow dimensions doesn't really fit... is this "grid-file" missing?
"All approaches have in common that the NetCDF
grid file must be read in together with the data file." (Icon tutorial 2023)
look at 2D files (WRF), land cover (forest, etc)
AROME: hgt (2D), ICON: z_ifc, UM: hgt, WRF: hgt
-> make own overview plot till concept presentation?


- rather look at 3D data, not extrapolation to surface! all models extrapolate differently... probably extrapolate by myself to have it consistent -> later
- manuela' variable guidelines, search them to find topo variable? -> not really helpful!

- WSL workspace folder:
\\wsl.localhost\Ubuntu-24.04\mnt\wslg\distro\home\daniel\workspace\regrid_icon

- Projections of Models:
	- AROME: 
  	- ICON is in regular lat/lon grid, which doesn't have to be WGS84 conformal. 
	- UM: rotated pole projection was used (to have least error near Ibk)
       		grid_mapping_name:            rotated_latitude_longitude
     		longitude_of_prime_meridian:  0.0
    		earth_radius:                 6371229.0
     		grid_north_pole_latitude:     42.70000076293945
     		grid_north_pole_longitude:    191.39999389648438
     		north_pole_grid_longitude:    0.0
  	- WRF: Do I have to interpolate WRF-model? from attrs of netCDF file: lambertian conformal projection
  	  '+proj=lcc +lat_0=47.3000068664551 +lon_0=11.3999996185303 +lat_1=44 +lat_2=60 +x_0=0 +y_0=0 +R=6370000 +units=m +no_defs'
  		Manuela's input: For projecting the data into a new coordinate system (e.g., WGS84), you can use cartopy.crs (https://scitools.org.uk/cartopy/docs/latest/reference/crs.html). But even in WGS84, you will
		not have a regular grid. For a regular grid, you will need to interpolate the data. Interpolation always means some sort of loss, but on the other hand having all models on the same grid has the advantage
		that you could also calculate differences between the simulations.

  	I would like to have UM & WRF data also in a regular lat/lon grid. How can I reproject/transform that?
  	-> plotting with defining a projection in cartopy is easy (for UM!), for WRF i get: ValueError: operands could not be broadcast together with shapes (1,189,289) (3,3) ...
  	-> how interpolating/transforming?
  		- Pyproj: wrong! documentation states that Area of use is important. Is not defined.
  		Maybe I have to set Area of use somehow to get transformation with pyproj working? Only for coordinate transformation into new projection?
  		- xESMF: not for Win, setup WSL env, and calc but get still error: Missing cf conventions: dataset is not cf-compatible...
  		- stay with scipy? -> probably have to use loop for different levels, times etc?! -> probably slow and a bit complicated!   	
   	- UM: subtract rotated_latitude_longitude from coords to have regular grid?
   	  tried with pyproj but isn't correct, check calcs again!
  	- WRF: scipy 2d interpolation? or rather pyproj with smth like:
  		pyproj.Proj(proj="lcc",
                           lat_1 = um.attrs["TRUELAT1"], lat_2 = um.attrs["TRUELAT2"],
                           lat_0 = um.attrs["MOAD_CEN_LAT"], lon_0 = um.attrs["STAND_LON"],
                           a=6370000, b=6370000)
    		-> for now: continue with AROME & ICON, maybe include others later 
  	  	having completely same grid is most important for cross sections: that one can compare completely the same points.
  		can be calculated (interpolated) also later for 1 var if cross sect wanted.

		=> Manuela regridded WRF & UM, no worries anymore!



Verbesserungs ToDo's für die ich mir keine Zeit nehmen will:
- maybe us pickle for make read in faster? binary data formats. But it works for now.
- create one file "general_calculations"? for slope angles and future stuff?
- maybe overthink read in function setup again (to have enough functions with 1 task...)

erledigt:
- Einleseroutinen viel um/neugeschrieben
- hannes' code funktioniert nun auch bei mir
- cosma haben eig daten gefehlt, bzw hat sie AROME-Einleseroutine von hannes gar nicht verwendet!
- all metpy calculations now much faster
- create uniform time & height coordinates! (rename them) -> works now perfectly! also for regridded data...
- Einleseroutinen viel um/neugeschrieben
- hannes' code funktioniert nun auch bei mir
- cosma haben eig daten gefehlt, bzw hat sie AROME-Einleseroutine von hannes gar nicht verwendet!
- all metpy calculations now much faster
- create uniform time & height coordinates! (rename them) -> done

code optimization: 
- merge datasets every iteration through the variables?
- create a list, put datasets into it, then merge it with xr.merge => muuuuuch faster!!! 
quantify makes code pretty slow, use less often?!
still not sure how metpy calcs can be done fast with variables:
- rather define new variable with units
- or assign units to dataset and then dequantify again? -> small effect!)

cosma just adapted, often hard coded codes from Hannes. "zeitreihen"-notebooks meist sinnlos. Hannes hat 0 tests geschrieben...

heights of cosma: 
87: (icon, lowest lvl where?)
80: (icon2te)
56: hafelekar


old stuff:

Codes follow those provided by Hannes Wieser, but using Jupyter Notebooks (.ipynb).
All read-in's, calculations and plots are provided for the cities Innsbruck, Kufstein and Imst.

## Data

* Radiosounding
* HOBOs
* HATPRO
* AROME
* WRF (also called WRF_acinn or WRF_helen)
* UM (also called UKMO)
* ICON and ICON2TE


## Calculations and plots

Contain calculations of stability parameters, CAP depth and CAP characteristics such as T, P.

##### Stability parameters

* absolute T differences
* th gradients
* Brunt-Väisälä frequency
* Non-dimensional Valley depth
* Valley Heat deficit


## Additional Calculations

* time series (Zeitreihen)
* principal component analysis (PCA)
* Model domains and locations of Innsbruck, Kufstein, Imst


## Requirements

* confg.py
* adjust directory of all files which are read on top of each .ipynb.

##### Package requirements

* cartopy 0.22.0
* matplotlib 3.5.2
* metpy 1.4.1
* netcdf4 1.6.2
* numpy 1.26.1
* pandas 2.2.3
* rasterio 1.4.1
* salem 0.3.11
* skipy 1.13.1
* wrf_python 1.3.4.1
* xarray 2024.7.0


























































































































